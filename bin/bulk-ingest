#!/usr/bin/env python
from tarxiv.data_sources import TNS, ATLAS, ASAS_SN, ZTF
from tarxiv.database import TarxivDB
from tarxiv.utils import clean_meta
import pandas as pd
import argparse

# Get config dir from arguments
parser = argparse.ArgumentParser('bulk-ingest',
                                 description="TarXiv Bulk Ingestion. "
                                             "Ingest TNS back catalog into TarXiv")
parser.add_argument('--debug', action='store_true', default=False,
                         help='set to enable printing/logging in debug mode')
parser.add_argument("config_dir", type=str,
                    help="path to directory containing config files")
args = parser.parse_args()


# Create survey objects
txv_tns = TNS(args.config_dir, debug=args.debug)
txv_atlas = ATLAS(args.config_dir, debug=args.debug)
txv_ztf = ZTF(args.config_dir, debug=args.debug)
txv_asas_sn = ASAS_SN(args.config_dir, debug=args.debug)

# Connect to couchbase and get initial schema
txv_db = TarxivDB(args.config_dir, debug=args.debug)
schema = txv_db.get_object_schema()

# First download bulk dataframe
bulk_df = txv_tns.download_bulk_tns()
# Get object names
obj_list = bulk_df['name'].tolist()

# Process all
for obj_name in obj_list:
    # Get initial info from TNS
    tns_meta, _ = txv_tns.get_object(obj_name)
    ra_deg, dec_deg = tns_meta['ra_deg']["value"], tns_meta['dec_deg']["value"]
    # Now get meta and lightcurves from the surveys
    atlas_meta, atlas_lc = txv_atlas.get_object(obj_name, ra_deg, dec_deg)
    ztf_meta, ztf_lc = txv_ztf.get_object(obj_name, ra_deg, dec_deg)
    asas_sn_meta, asas_sn_lc = txv_asas_sn.get_object(obj_name, ra_deg, dec_deg)

    # Now we populate schema with our survey information
    obj_meta = txv_tns.update_object_meta(schema, tns_meta)
    obj_meta = txv_atlas.update_object_meta(obj_meta, atlas_meta)
    obj_meta = txv_ztf.update_object_meta(obj_meta, ztf_meta)
    obj_meta = txv_asas_sn.update_object_meta(obj_meta, asas_sn_meta)
    # Collate lightcurves and add peak mag measurements to schema
    lc_df = pd.concat([atlas_lc, ztf_lc, asas_sn_lc])
    # Add peak magnitudes to meta
    obj_meta = txv_tns.meta_add_peak_mags(obj_meta, lc_df)
    obj_meta = clean_meta(obj_meta)
    # Convert to json for submission
    obj_lc = lc_df.to_dict(orient="records")
    # Push to database
    txv_db.upsert(obj_name, obj_meta, "tns_objects")
    txv_db.upsert(obj_name, obj_lc, "tns_lightcurves")
