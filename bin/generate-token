#!/usr/bin/env python
# Run locally to generate a gmail token and copy it up to the deployment server

from tarxiv.alerts import Gmail
import subprocess
import argparse
import os

# Get config dir from arguments
parser = argparse.ArgumentParser('generate-token',
                                 description="Generate a gmail token and copy it up to the deployment server.")
parser.add_argument('--debug', action='store_true', default=False,
                         help='set to enable printing/logging in debug mode')
parser.add_argument("config_dir", type=str,
                    help="path to directory containing config files")
args = parser.parse_args()

# Create object
txv_gmail = Gmail(args.config_dir, debug=args.debug)
token_file = os.path.join(args.config_dir, "gmail_token.json")
token_dest = f"{txv_gmail.config['user']}@{txv_gmail.config['host']}:~/tarxiv-dev/aux/"
try:
    result = subprocess.run(['scp', token_file, token_dest], capture_output=True, text=True, check=True)
    print(result.stdout)
except subprocess.CalledProcessError as e:
    print(f"Error executing SCP command: {e}")
    print(f"SCP Stderr: {e.stderr}")
except Exception as e:
    print(f"An unexpected error occurred: {e}")

print("Done")


